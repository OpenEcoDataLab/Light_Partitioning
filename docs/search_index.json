[["data-quality-assessments.html", "Part 3 Data quality assessments 3.1 Chl-a to biomass 3.2 Data-driven qa/qc", " Part 3 Data quality assessments Note, also eval = F to save computation time 3.1 Chl-a to biomass While it is more common in coastal and oceanic research, inland water scientists rarely measure water clarity constituents in the way that is most directly transferable to our research question. Ideally we would routinely measure concentrations of algae biomass, non-algal particles (including inorganic sediment and organic sediment, I like to call this stuff dead suspended sediment, but I guess NAP is fine), and dissolved organic carbon. These constituents all alter light penetration in water, but they are mutually exclusive groups with no measurement overlap between algal particles and NAP for example. However, this is not what we usually measure. Instead, we have rich datasets of things that could indicate our desired constituents. These map as basically. Chlorophyll-a -&gt; proxy for algae biomass. Total suspended solids (tss) -&gt; All suspended solids, subtract algae biomass = NAP DOC -&gt; DOC! That means we have to basically do one key calculation. Convert chl-a to biomass. Then subtract that from tss and assume that is NAP. While this is a absurdly simple calculation it is filled with dangers. The relationship between chl-a and algae biomass depends on temperature and nutrients and species and is not universal. Most studies focus on Chl:C ratios, but we are interested in Chl:Biomass ratio, for which there are much fewer studies, though some studies below suggest a range of 0.005 to 0.1 Chl:biomass. (I need to find the C:Biomass study I used forever ago.) Papers that help: https://aslopubs.onlinelibrary.wiley.com/doi/full/10.1002/lno.10338 https://pubs.usgs.gov/twri/twri9a7/twri9a7_7.4.pdf https://www.researchgate.net/publication/230056019_Relationship_between_Chlorophyll-a_Concentration_and_Phytoplankton_Biomass_in_Several_Reservoirs_in_Czechoslovakia/link/5cb56c164585156cd79af804/download https://archimer.ifremer.fr/doc/2005/publication-1172.pdf 3.1.1 Approach Our philosphy here is that we will use chl-a directly as a proxy for algal biomass to minimize the number of transformations to this data, since we are primarily interested in how algae alters light attenuation, regardless of how we estimate algae. However, we still need to calculate Non-Algal Particle mass. For that we will use a range of values of Chl:biomass and show the impact of picking a variety of ranges. Caveats We dont have a true NAP to compare how accurate our approach is. We do have Inorganic Sediment, but that is not the same thing as non-algal particles, since it excludes particulate organic carbon. Still, where we have it, we will examine the relationship between NAP and TIS (total inorganic sediment). Not entirely sure how we propogate this uncertainty downstream? Pick an average? in_vis &lt;- read_feather(&#39;data/out/simul.feather&#39;) range &lt;- c(50, 100, 200, 234) #Couldn&#39;t think of a more clever way to multiply #chl_a by the range of values, so just made # dataframe 4 times bigger with new column called ratio. nap_test &lt;- expand_grid(in_vis,chl_ratio = range) %&gt;% mutate(power = ifelse(chl_ratio == 234, 0.57, 1), chl_a_biomass = exp(log(chl_ratio/1000)+log(chl_a)*power), tss_dead = tss-chl_a_biomass) 3.1.2 Simple evaluations of conversion 3.1.2.1 Negative tss_dead Probably the simplest way to see which ratios are more appropriate is to look at how that impacts how many tss_dead observations are negative (impossible). nap_test %&gt;% mutate(negative = ifelse(tss_dead &lt; 0, &#39;negative&#39;, &#39;positive&#39;)) %&gt;% group_by(negative,chl_ratio) %&gt;% count() %&gt;% pivot_wider(names_from = &#39;negative&#39;,values_from = &#39;n&#39;) %&gt;% mutate(percent_neg = negative/(positive+negative)*100) %&gt;% knitr::kable() chl_ratio negative positive percent_neg 50 266 100557 0.2638287 100 968 99855 0.9600984 200 5137 95686 5.0950676 234 472 100351 0.4681471 Well, that sort of produces obvious results. Smaller ratios mean, less negative NAP estimates, but there is a big increase between 100-200, making me think the correct ratio may be in there somewhere. 3.1.2.2 Relationship between chl-a and tss_dead If you recall from the previous section, there was a strong linear relationship between chl-a and tss across all sites and water types (r2 &gt; 0.35). One effect wed expect to see with the tss_dead estimate is that this relationship should decay. While there are reasons for chl-a to be correlated with tss (sediment brings nutrients for example), chl-a also includes algal cells which are suspended particles themselves. If this approach worked well, we should see weaker relationships between tss_dead and chl-a #Subset for plotting purposes nap_test %&gt;% #Remove negatives and very small numbers (ug/L of sediment is basically zero) filter(tss_dead &gt; 0.001) %&gt;% sample_frac(0.1) %&gt;% ggplot(., aes(chl_a,tss_dead,color = type)) + facet_wrap(~chl_ratio) + geom_point() + scale_x_log10() + scale_y_log10() + stat_poly_eq() + ggthemes::theme_few() + scale_color_manual(values = c(&#39;seagreen3&#39;,&#39;skyblue3&#39;,&#39;saddlebrown&#39;)) Figure 3.1: At low chl_ratios (10/20), there is really no change to the correlation between tss and chl_a, but at higher ratios (100/200), the relationship does breakdown some, though not completely What to do with this? 234*chl^0.57 seems logical but still high correlation in lakes between tss/chl_a, but that may be a real thing for lakes? (corr is actually higher with this approach) 3.2 Data-driven qa/qc We know that data in the water quality portal (and therfore in aquasat) comes with inherent biases and problems that are a natural part of aggregated massive datasets like the WQP. So how do we evaluate data quality in this context? Here we assume that some answers about data quality can be found in the original WQP data context including analytical and field methods data as well as information about which organizations collected the sample. The sketchy part? We dont have a systematic way to understand if data is unreliable except for The contributions of each our constituents to clarity should be limited by physical limits of how light interacts with particles, algae, and DOC. So if we build a model of light extinction as a function of f(doc, chl_a, tss_dead), the worst residuals on that model, might inform data quality. Then we can subset data to only include data of the highest quality. 3.2.1 Extracting methods AquaSat chose (I) to remove methods info from the raw wqp data, but we kept it in a second file that we already downloaded. We just need to manipulate that data to play nice with our simultaneous observation data. #This chunk is slow and therefore not run in bookdown. #get WQP methods for post-hoc investigation of errors simul_methods &lt;- data.table::fread(&#39;data/in/aq_situ/in-situ/wqp_long_with_methods.csv&#39;) %&gt;% dplyr::filter(SiteID %in% in_vis$SiteID) simul_methods_time_fix &lt;- simul_methods %&gt;% mutate(time = as.character(format(date_time, &#39;%H:%M:%S&#39;)), date_only=ifelse(is.na(date_time) | time == &#39;00:00:00&#39;,T,F), date_unity = ymd_hms(ifelse(date_only == T, paste(date,&#39;12:00:00&#39;), as.character(date_time)), tz=&#39;UTC&#39;)) %&gt;% mutate(time = as.character(format(date_unity, &#39;%H:%M:%S&#39;)), date_unity = ifelse(time == &#39;00:00:00&#39;, date_unity + hours(12), date_unity) %&gt;% #Convert back to poxict () as.POSIXct(.,origin=&#39;1970-01-01 00:00:00&#39;,tz=&#39;UTC&#39;)) %&gt;% #remove any time stamps that are NA filter(!is.na(date_unity)) %&gt;% filter(year(date_unity) &gt; 1900, year(date_unity) &lt;= year(Sys.Date())) %&gt;% #select(SiteID,date,characteristicName) %&gt;% as_tibble() %&gt;% dplyr::select(-date_only) %&gt;% mutate(harmonized_parameter = gsub(&#39;chl.a&#39;,&#39;chl_a&#39;,harmonized_parameter)) simul_vis_long &lt;- in_vis %&gt;% pivot_longer(cols = chl_a:tss,names_to = &#39;harmonized_parameter&#39;) simul_vis_methods &lt;- full_join(simul_methods_time_fix,simul_vis_long) #Fast feather::write_feather(simul_vis_methods, &#39;data/out/simul_methods.feather&#39;) # Reproducible write_csv(simul_vis_methods,&#39;data/out/simul_methods.csv&#39;) 3.2.2 Light attenuation model and residuals Model assumptions Not searching for intercept assuming observed 0.15 coefficient for intercept (pure water attenuation) For now, not doing the middle 2.5-97.5% of data, can add back in. Normality assumptions arent fully met nap_est &lt;- nap_test %&gt;% filter(chl_ratio == 234, tss_dead &gt; 0.001) %&gt;% mutate(secchi = ifelse(secchi &lt; 0.01,0.01,secchi), kd = (1/(secchi))) k_w &lt;- 1/1.5/max(nap_est$secchi) kd_mod &lt;- lm((kd-k_w) ~ 0 +tss_dead + doc + chl_a, data = nap_est) nap_est$pred &lt;- kd_mod$fitted.values nap_est$residuals &lt;- kd_mod$residuals nap_est %&gt;% sample_frac(0.3) %&gt;% ggplot(., aes(kd,pred)) + geom_point(shape = 1) + ggthemes::theme_few() + xlab(&#39;kd (1.4/secchi)&#39;) + ylab(&#39;predicted kd&#39;) + scale_x_log10() + scale_y_log10() + stat_smooth(method = &#39;lm&#39;,se = F) + geom_abline(intercept = 0, slope = 1, col = &#39;red&#39;) ## `geom_smooth()` using formula &#39;y ~ x&#39; Figure 3.2: modelled light extinction coefficient versus observed, red line is 1:1 line and blue is line of best fit 3.2.3 Systematic problems? 3.2.3.1 Analytical Methods and Error Characterization simul_vis_methods &lt;- feather::read_feather(&#39;data/out/simul_methods.feather&#39;) methods_summarizer &lt;- function(param = &#39;chl_a&#39;){ methods &lt;- simul_vis_methods %&gt;% filter(harmonized_parameter == param) %&gt;% inner_join(nap_est %&gt;% select(SiteID,date_unity,residuals,pred,kd)) method_plot &lt;- methods %&gt;% group_by(analytical_method) %&gt;% add_count() %&gt;% mutate(method_count = paste(&#39;n =&#39;,n,&#39;-&#39;,analytical_method)) %&gt;% ggplot(., aes(kd,pred,color = method_count)) + #geom_point(shape = 1) + ggthemes::theme_few() + xlab(&#39;kd (1.4/secchi)&#39;) + ylab(&#39;predicted kd&#39;) + scale_x_log10() + scale_y_log10() + stat_smooth(method = &#39;lm&#39;,se=F) + geom_abline(intercept = 0, slope = 1, col = &#39;black&#39;) method_error &lt;- methods %&gt;% group_by(analytical_method) %&gt;% summarize(rmse = rmse(kd,pred), resid_cv = sd(residuals)/mean(residuals), n = n(), resid_se = sd(residuals)/(n^0.5), mdae = mdae(kd,pred)) %&gt;% arrange(-n) %&gt;% mutate(across(is.numeric, ~(round(.x, 1))), param = param) name_error &lt;- methods %&gt;% group_by(characteristicName) %&gt;% summarize(rmse = rmse(kd,pred), resid_cv = sd(residuals)/mean(residuals), n = n(), resid_se = sd(residuals)/(n^0.5), mdae = mdae(kd,pred)) %&gt;% arrange(-n) %&gt;% mutate(across(is.numeric, ~(round(.x, 1))), param = param) name_plot &lt;- methods %&gt;% group_by(characteristicName) %&gt;% add_count() %&gt;% mutate(name_count = paste(&#39;n =&#39;,n,&#39;-&#39;,characteristicName)) %&gt;% ggplot(., aes(kd,pred,color = name_count)) + #geom_point(shape = 1) + ggthemes::theme_few() + xlab(&#39;kd (1.4/secchi)&#39;) + ylab(&#39;predicted kd&#39;) + scale_x_log10() + scale_y_log10() + stat_smooth(method = &#39;lm&#39;,se=F) + geom_abline(intercept = 0, slope = 1, col = &#39;black&#39;) return(list(method_error,name_error,method_plot,name_plot)) } chl_errors &lt;- methods_summarizer(&#39;chl_a&#39;) ## Joining, by = c(&quot;SiteID&quot;, &quot;date_unity&quot;) ## Warning: Predicate functions must be wrapped in `where()`. ## ## # Bad ## data %&gt;% select(is.numeric) ## ## # Good ## data %&gt;% select(where(is.numeric)) ## ## i Please update your code. ## This message is displayed once per session. doc_errors &lt;- methods_summarizer(&#39;doc&#39;) ## Joining, by = c(&quot;SiteID&quot;, &quot;date_unity&quot;) tss_errors &lt;- methods_summarizer(&#39;tss&#39;) ## Joining, by = c(&quot;SiteID&quot;, &quot;date_unity&quot;) secchi_errors &lt;- methods_summarizer(&#39;secchi&#39;) ## Joining, by = c(&quot;SiteID&quot;, &quot;date_unity&quot;) all_errors &lt;- rbind(chl_errors[[1]],doc_errors[[1]], tss_errors[[1]],secchi_errors[[1]]) knitr::kable(all_errors) %&gt;% kable_paper() %&gt;% scroll_box(width = &#39;100%&#39;, height = &#39;400px&#39;) %&gt;% kable_styling(bootstrap_options = &#39;striped&#39;, full_width = ) analytical_method rmse resid_cv n resid_se mdae param MONOCHROMATIC; SPECTROPHOTOMETRIC 2.4 4.1 36528 0.0 0.5 chl_a NA 2.3 21.0 29822 0.0 0.5 chl_a 10200 H ~ Chlorophyll a-b-c Determination 1.4 118.4 24876 0.0 0.4 chl_a In-Vitro Determination of Chlorophyll 1.7 3.4 14996 0.0 0.6 chl_a L01 1.4 3.1 386 0.1 0.3 chl_a Chlorophyll, phytoplankton, HPLC 1.7 28.4 318 0.1 0.3 chl_a SM10200H 3.7 1.2 237 0.2 1.8 chl_a Chlorophyll a,phyto,fluorometric 3.2 -3.6 227 0.2 0.8 chl_a FLUOROMETIC CHLOROPHYLL USING PROBE 0.4 -15.0 184 0.0 0.2 chl_a L02 9.6 11.0 109 0.9 0.2 chl_a 10200 H 2 ~ Chlorophyll a-b-c Determination by spectrophotometer 0.3 2.0 81 0.0 0.2 chl_a Laboratory Procedures for Water Quality Chemical Analysis 2.9 1.3 54 0.3 1.1 chl_a CHLOROPHYLL-A UG/L SPECTROPHOTOMETRIC ACID. METH. 0.3 -0.9 48 0.0 0.2 chl_a Chlorophyll a-b-c- Determination 0.9 2.1 42 0.1 0.5 chl_a FLUOROMETRIC; IN-VITRO CHLOROPHYLL A 0.4 3.2 41 0.1 0.2 chl_a Chlorophyll a, phytoplankton 0.9 -1.1 8 0.2 1.0 chl_a Chlorophyll via HPLC / Spectrophotometer 3.2 0.4 3 0.7 3.6 chl_a STANDARD METHOD FOR 10200 H 1.1 1.6 3 0.6 0.2 chl_a Pigments, algae, EPA445.0 w/ACTN 2.1 0.4 2 0.5 2.0 chl_a Total Organic Carbon by Combustion 2.3 3.3 29437 0.0 0.6 doc NA 1.8 71.3 28359 0.0 0.4 doc 5310 B ~ Total Organic Carbon by Combustion-Infrared Method 1.4 54.7 22268 0.0 0.5 doc WET OXIDATION METHOD 0.7 177.5 10359 0.0 0.2 doc UV OR HEATED PERSULFATE OXIDATION 3.5 4.8 5889 0.0 0.5 doc Low Level Total Organic Carbon in Water 1.2 2.4 3660 0.0 0.3 doc 5310 B ~ Total Organic Carbon by High-Temperature Combustion Method 1.9 2.6 3471 0.0 0.5 doc 5310 C ~ Total Organic Carbon in Water- Ultraviolet Oxidation Method 0.9 7.4 1580 0.0 0.4 doc L02 0.4 -2.9 257 0.0 0.2 doc DOC,0.45um cap,acid,persulfateIR 3.0 -4.0 248 0.2 1.0 doc SM5310B 3.7 1.2 237 0.2 1.8 doc L01 1.9 1.8 208 0.1 0.4 doc DOC, 0.45u silver, persulfate IR 2.4 19.0 186 0.2 0.5 doc DOC, EPA method 0.7 1.5 124 0.0 0.3 doc Laboratory Procedures for Water Quality Chemical Analysis 2.9 1.3 54 0.3 1.1 doc CARBON, DISSOLVED ORGANIC (MG/L AS C) 0.3 -0.9 48 0.0 0.2 doc TOC - Persulfate-Ultraviolet or Heated-Persulfate Oxidation Method 0.9 2.1 42 0.1 0.5 doc Total Organic Carbon in Water and Waste 17.7 4.4 32 3.1 0.4 doc L03 18.2 5.4 30 3.3 0.3 doc Other or Unknown Procedure 0.7 -1.5 16 0.1 0.4 doc DOC, 0.7um GFF,acid,persulfateIR 1.3 1.0 8 0.3 1.0 doc DOC, CO2 formation &amp; detection 2.2 1.1 7 0.6 1.8 doc 9060 AM ~ Total Volatile Organic Carbon 0.4 -0.2 5 0.0 0.4 doc DOC, wf, 0.45 um cap, combust IR 1.9 0.5 4 0.4 1.7 doc Temperature 0.9 -0.6 3 0.3 0.9 doc TOTAL CARBON ANALYSIS 1.1 1.6 3 0.6 0.2 doc Organic-C, combustion-IR method 0.0 NA 1 NA 0.0 doc NA 2.0 6.9 98129 0.0 0.5 tss Non-Filterable Residue - TSS 0.8 2.6 2038 0.0 0.2 tss L01 0.4 1.0 117 0.0 0.3 tss 2540 D ~ Total Suspended Solids in Water 3.6 3.9 34 0.6 0.7 tss Residue by Evaporation and Gravimetric 0.8 1.1 18 0.1 0.4 tss Suspended-Sediment in Water 1.4 0.8 14 0.2 1.1 tss NA 1.9 32.1 36482 0.0 0.4 secchi 20 CM SECCHI DEPTH 2.5 4.0 35962 0.0 0.5 secchi EPA/620/R-01/003 Secchi Depth 1.7 2.8 14970 0.0 0.5 secchi Other or Unknown Procedure 1.3 -7.1 12083 0.0 0.4 secchi Determination of Secchi Disk Transparency 0.9 -6.2 3610 0.0 0.5 secchi Field measurement/observation, generic method 0.7 -1.1 1489 0.0 0.5 secchi ISU Secchi Method 1.3 4.0 1288 0.0 0.4 secchi 30 CM SECCHI DEPTH 0.4 -2.7 791 0.0 0.2 secchi Tyler, John. 1968. The secchi disk, Limnology and Oceanograpy, 13(1):1-6. 1.8 2.7 667 0.1 0.8 secchi Field measurement of Light Penetration (Secchi Depth and Transparency) 0.5 -1.5 581 0.0 0.4 secchi Unknown 1.7 -0.6 383 0.0 1.5 secchi Laboratory Procedures for Water Quality Chemical Analysis 3.6 1.2 291 0.2 1.7 secchi F02 0.4 -2.9 257 0.0 0.2 secchi F01 6.7 5.4 238 0.4 0.4 secchi Secchi disk method 0.9 1.5 139 0.1 0.3 secchi Depth, Secchi disk depth 1.4 1.3 23 0.2 0.3 secchi UNKOWN 0.9 -1.3 13 0.2 0.8 secchi FIELD MEASUREMENT OF LIGHT PENETRATION (SECCHI DEPTH AND TRANSPARENCY) 2.3 0.9 4 0.8 2.3 secchi Field Measurements performed by Utah DWQ 3.1 0.3 4 0.5 3.1 secchi FIELD PARAMETERS 1.1 1.6 3 0.6 0.2 secchi Secchi Depth 0.2 0.6 2 0.1 0.2 secchi SOP-1 VCEH Lab Surface Water SOP 1.0 -0.3 2 0.2 1.0 secchi WSSSOP 0.4 -0.2 2 0.1 0.4 secchi Field methods for DEQ Water sampling 0.1 NA 1 NA 0.1 secchi 3.2.3.2 Chl-a names knitr::kable(chl_errors[[2]]) characteristicName rmse resid_cv n resid_se mdae param Chlorophyll a 2.1 5.3 79989 0.0 0.5 chl_a Chlorophyll a, corrected for pheophytin 1.3 -10.4 15975 0.0 0.4 chl_a NA 2.7 11.4 11950 0.0 0.5 chl_a Chlorophyll a (probe relative fluorescence) 1.7 1.7 32 0.3 0.5 chl_a Chlorophyll a (probe) 8.3 2.2 13 2.2 0.4 chl_a Chlorophyll a, free of pheophytin 2.3 1.7 6 0.9 1.4 chl_a 3.2.3.3 Jettison ADD SQUARE METHOD for chl-a to biomass CV of RMSE, Keep most abundant methods? Remove worst Keep most numerous Boost on errors High tss dead = high error. 1/secchi "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
